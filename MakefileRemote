#This file, from a list of hosts, does the following through ssh commands:
## cd QFP && git pull
## cd QFP/qfpc && make -j [appropriate number] -f Makefile2
## cd QFP && git add -u && git commit -m 'auto commit, test results'
## genDiffTable

testname ?= general

.phony: all

KINGSPEAK :whi= u0422778@kingspeak.chpc.utah.edu 12
CLAB :=  $(CLAB_CONNECT) 8
BIHEX := sawaya@bihexal.cs.utah.edu 24

HOSTS := KINGSPEAK BIHEX CLAB

TARGETS := $(foreach h, $(HOSTS), $h_exec)

all: $(TARGETS) pull_local

define RULE
$1_exec :
	-ssh $2 \
		'cd QFP &&
		git checkout dumpSQL &&
		git pull &&
		cd qfpc &&
		make -j $3 -f Makefile2 &&
		cd .. &&
		git add -u &&
		git commit -m "auto commit, test results" &&
		git push'
endef

$(foreach h, $(HOSTS), $(eval $(call RULE, $(strip $h), $(word 1, $($(strip $h))), $(word 2, $($(strip $h))))))

pull_local : $(TARGETS)
	git pull
