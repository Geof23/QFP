PINPATH := $(HOME)/software/pin

OUTDIR := opcounts

SOURCE := $(wildcard *_O0)
SOURCE += $(wildcard *_O1)
SOURCE += $(wildcard *_O2)
SOURCE += $(wildcard *_O3)

TESTS := DistributivityOfMultiplication RotateAndUnrotate DoSkewSymCPRotationTest\
	DoHariGSBasic DoHariGSImproved DoSimpleRotate90 TrianglePHeron\
	DoMatrixMultSanity DoOrthoPerturbTest TrianglePSylv RotateFullCircle\
	FtoDecToF subnormal dotProd simpleReduction addTOL addSub divc\
	zeroMinusX zeroDivX xDivOne xDivNegOne negAdivB twiceCast negAminB\
	xMinuxX negAplusB aXbDivC aXbXc aPbPc xPc1EqC2 xPc1NegC2

PRECISIONS := f d e

TARGETS := $(foreach p, $(PRECISIONS), \
	$(foreach t, $(TESTS), \
	$(foreach f, $(SOURCE), \
	$(strip $f)_$(strip $p)_$(strip $t))))

.phony : all

all : $(TARGETS)

define RULE
$1 : $2
	-PRECISION=$(strip $3) \
	TEST=$(strip $4) \
	$(PINPATH)/pin -t \
	$(PINPATH)/source/tools/SimpleExamples/obj-intel64/opcodemix.so \
	-o $$@ -- ./$$<
endef

$(foreach p, $(PRECISIONS), \
	$(foreach t, $(TESTS), \
	$(foreach f, $(SOURCE), \
	$(eval $(call RULE, $(strip $f)_$(strip $p)_$(strip $t), $(strip $f), $(strip $p), $(strip $t))))))
