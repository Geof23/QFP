'Implements the update subcommand'

import argparse
import os
import sys
import toml

import flitconfig as conf
import flitutil

brief_description = 'Updates the Makefile based on flit-config.toml'

def main(arguments, prog=sys.argv[0]):
    parser = argparse.ArgumentParser(
            prog=prog,
            description='''
                Updates the Makefile based on flit-config.toml.  The Makefile
                is autogenerated and should not be modified manually.  If there
                are things you want to replace or add, you can use custom.mk
                which is included at the end of the Makefile.  So, you may add
                rules, add to variables, or override variables.
                ''',
            )
    parser.add_argument('-C', '--directory', default='.',
                        help='The directory to initialize')
    args = parser.parse_args(arguments)

    tomlfile = os.path.join(args.directory, 'flit-config.toml')
    try:
        projconf = toml.load(tomlfile)
    except FileNotFoundError:
        print('Error: {0} not found.  Run "flit init"'.format(tomlfile),
              file=sys.stderr)
        return 1

    makefile = os.path.join(args.directory, 'Makefile')
    if os.path.exists(makefile):
        print('Updating {0}'.format(makefile))
    else:
        print('Creating {0}'.format(makefile))

    host = projconf['hosts'][0]
    dev_build = host['dev_build']
    dev_compiler_name = dev_build['compiler_name']
    dev_optl = dev_build['optimization_level']
    dev_switches = dev_build['switches']
    matching_dev_compilers = [x for x in host['compilers']
                              if x['name'] == dev_compiler_name]
    assert len(matching_dev_compilers) > 0, \
            'Compiler name {0} not found'.format(dev_compiler_name)
    assert len(matching_dev_compilers) < 2, \
            'Multiple compilers with name {0} found'.format(dev_compiler_name)
    dev_compiler_bin = matching_dev_compilers[0]['binary']
    if '/' in dev_compiler_bin:
        dev_compiler_bin = os.path.realpath(dev_compiler_bin)

    ground_truth = host['ground_truth']
    gt_compiler_name = ground_truth['compiler_name']
    gt_optl = ground_truth['optimization_level']
    gt_switches = ground_truth['switches']
    matching_gt_compilers = [x for x in host['compilers']
                             if x['name'] == gt_compiler_name]
    assert len(matching_dev_compilers) > 0, \
            'Compiler name {0} not found'.format(gt_compiler_name)
    assert len(matching_dev_compilers) < 2, \
            'Multiple compilers with name {0} found'.format(gt_compiler_names)
    # TODO: use the compiler mnemonic rather than the path
    gt_compiler_bin = matching_gt_compilers[0]['binary']
    if '/' in dev_compiler_bin:
        gt_compiler_bin = os.path.realpath(gt_compiler_name)

    flitutil.process_in_file(
        os.path.join(conf.data_dir, 'Makefile.in'),
        makefile,
        {
            'dev_compiler': dev_compiler_bin,
            'dev_optl': dev_optl,
            'dev_switches': dev_switches,
            'ground_truth_compiler': gt_compiler_bin,
            'ground_truth_optl': gt_optl,
            'ground_truth_switches': gt_switches,
            'flit_include_dir': conf.include_dir,
            'flit_lib_dir': conf.lib_dir,
            'flit_data_dir': conf.data_dir,
            'flit_script_dir': conf.script_dir,
        },
        overwrite=True)

if __name__ == '__main__':
    sys.exit(main(sys.argv[1:]))
